param(
  [string]$Target = "C:\_emu\anoraapp-ai"
)

$ErrorActionPreference = "Stop"

# Ensure target exists
if (!(Test-Path $Target)) { New-Item -ItemType Directory -Force -Path $Target | Out-Null }

Write-Host "==> START emulators (import from $Target)"
# Start emulators in this window. On Ctrl+C, Firebase will *try* to export and may fail on rename.
firebase emulators:start `
  --config ".\firebase.json" `
  --only "firestore,auth,functions" `
  --import "$Target" `
  --export-on-exit "$Target"

Write-Host "==> Emulator process ended. Promoting latest firebase-export-* into $Target (workaround for rename EPERM)."

# Find newest temp export folder
$latest = Get-ChildItem -Force -Directory . |
  Where-Object Name -like "firebase-export-*" |
  Sort-Object LastWriteTime -Descending |
  Select-Object -First 1

if (-not $latest) {
  Write-Host "!! No firebase-export-* folder found. Nothing to promote."
  exit 0
}

Write-Host "==> Latest temp export: $($latest.FullName)"

# Validate expected structure
$auth = Join-Path $latest.FullName "auth_export"
$fs   = Join-Path $latest.FullName "firestore_export"
if (!(Test-Path $auth) -or !(Test-Path $fs)) {
  Write-Host "!! Temp export missing auth_export/firestore_export. Abort."
  exit 1
}

# Wipe target content (but keep the folder) to avoid mixing exports
Write-Host "==> Cleaning target folder content..."
Get-ChildItem -Force $Target | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Copy export into target using robocopy (handles lots of files + permissions better than Copy-Item)
Write-Host "==> Copying export -> target (robocopy)..."
$rc = robocopy $latest.FullName $Target /MIR /R:1 /W:1 /NFL /NDL /NJH /NJS
# robocopy exit codes: 0-7 are success-ish
if ($LASTEXITCODE -gt 7) {
  Write-Host "!! Robocopy failed with exit code $LASTEXITCODE"
  exit 2
}

Write-Host "✅ Promote complete. Next run will import from: $Target"
